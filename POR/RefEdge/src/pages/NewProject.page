<!--
 * ReferenceEdge
 * 
 * Point of Reference, Inc. - Copyright 2014 All rights reserved.
 *
 * @company : Point of Reference, Inc.
 * @website : www.point-of-reference.com
 *
 * Disclaimer: THIS SOFTWARE IS PROVIDED "AS-IS" BY POINT OF REFERENCE ("POR"), 
 * WITH NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, 
 * EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
 * POR SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, 
 * MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES. POR IS NOT LIABLE FOR, 
 * AND MAKES NO REPRESENTATIONS OR WARRANTIES REGARDING, THE ACTIONS OR OMISSIONS OF 
 * ANY THIRD PARTIES (OR THE PRODUCTS OR SERVICES OFFERED BY ANY THIRD PARTIES) INCLUDING, 
 * WITHOUT LIMIATION, SALESFORCE.COM. COPY, USE OR DISTRIBUTION PROHIBITED WITHOUT EXPRESS 
 * WRITTEN CONSENT FROM COMPANY.
 -->
<apex:page Controller="NewProjectController" sidebar="false" id="pgId">
    <apex:pageMessages id="pgmsgId"/>
    <c:POR_ModalLoader id="PORLoader"/>
    <style>
        .pbSubheader
        {
            background-image : none !important;
        }
        /*css used to remove bullets from error message -#922*/
        li {
    		list-style-type: none;
		}
    </style>
    <script>
        var defaultOpp = '';
        var defaultCase = '';
        var projectType = 'member';
        var porlookUpWindowOpen = false;
        var selectedAccId = '';
        var pornewWin = null; 
        var popupflag = false;
        PORShowLoading();
        jQuery(window).load(function() {
            defaultOpp = document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt') != null 
            		? document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href : '';
            defaultCase = document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt') != null 
            		? document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href : '';
            
            if ('{!JSENCODE(projectType)}' == 'Candidate') {
                changeProject('{!JSENCODE(projectType)}', false);
            } else {
            	caseOppDisable();
            	
            	if (document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId') != null && 
            		document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').value != '') {
		            document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').disabled = true;
	            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href = '#';
            	}
            	
            	if (document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1') != null &&
            		document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').value != '') {
		            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').disabled = true;
		            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href = '#';
		        }
            }
            PORHideLoading();
        });
    </script>
    <apex:outputPanel id="jsPanel">
        <script>
            function ShowLookup(compId) {
            
			    if (!porlookUpWindowOpen) {
			        porlookUpWindowOpen = true;
			        popupflag = true;
			        var accName = document.getElementById('pgId:formId:blockId:SectionId:pbsAccountId:searchAccount').value;
			        
			        if (projectType == 'candidate') {
			            pornewWin = window.open(encodeURI('{!$Page.AddRequestAccountLookup}?strText=' + accName) + '&type=candidate', 'Popup', 'height=500,width=700,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');
			        } else if (projectType == 'member') {
			            pornewWin = window.open(encodeURI('{!$Page.AddRequestAccountLookup}?strText=' + accName) + '&type=member', 'Popup', 'height=500,width=700,left=100,top=100,resizable=no,scrollbars=yes,toolbar=no,status=no');
			        }
			        porlookUpWindowOpen = false;
			    }
			}
			
			function closePopup(Id, Name) {
			    
			    if (null != pornewWin) {
			        pornewWin.close();
			        
			        if (typeof Name != 'undefined') {
			            
			            if (popupflag) {
			                document.getElementById("pgId:formId:blockId:SectionId:pbsAccountId:searchAccount").value = Name;
			                PORShowLoading();
			                setAccountId(Id);
			                popupflag = false;
			            }
			        }
			    }
			}
			var isContactReferenceable = {!contactReferenceability};
			var isContactSelected = {!isContactSelected};
			
			var accountMSG = '{!JSENCODE(status)}'.replace('@@@1', '{!$Label.Account}');
			var contactMSG = '{!JSENCODE(status)}'.replace('@@@1', '{!$Label.Contact}');
			
			function showPopup() {
			    
			    if (!isAccountCandidate) {
			        
			        if (isContactSelected && !isContactReferenceable) {
			            var where_to = confirm(contactMSG);
			            
			            if (where_to) {
			                return true;
			            } else {
			                return false;
		                }
			        } else if (isAccountSelected && !isAccountReferenceable) {
			            var where_to = confirm(accountMSG);
			            
			            if (where_to) {
			                return true;
			            } else {
			                return false;
		                }
			        }
			    } else {
			        return true;
			    }
			}
			function caseOppDisable() {
				
		        if ({!oppRequired} && document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId') != null) {
		            document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').disabled = true;
	            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href = '#';
            	}
            	
            	if ({!caseRequired} && document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1') != null) {
		            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').disabled = true;
		            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href = '#';
		        }
			}
			
			function disableOppCase(changedValue, id) {
				console.log(changedValue + '**  ' + id);
				
			    if (changedValue != null && changedValue != '' && changedValue.trim() != '') {
			    
			        if (id == 'Opportunity1') {
			            
			            if (document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId') != null) {
			            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').disabled = true;
			            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href = '#';
			            }
			        } else {
			        
			        	if (document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1') != null) {
				            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').disabled = true;
				            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href = '#';
			        	}
		            }
			    } else {
			    
			        if (id == 'Opportunity1') {
			        
			            if (document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId') != null) {
			            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').disabled = false;
			            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href = defaultCase;
			            }
			        } else {
			            
			            if (document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1') != null) {
				            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').disabled = false;
				            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href = defaultOpp;
			        	}
		            }
			    }
			}
			
			function changeProject(type, clearAccount) {
			    
			    if (type == 'Member') {
			        projectType = 'member';
			        
			        if (document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1') != null) {
			            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href = defaultOpp;
			            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').disabled = false;
			            
				        if ({!oppRequired}) {
				            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:oppReq').style.display = '';
				        }
		        	}
			        
			        if (document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId') != null) {
		            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').disabled = false;
				        document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href = defaultCase;
				        
				        if ({!caseRequired}) {
				            document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseReq').style.display = '';
				        }
		            }
			        document.getElementById('pgId:formId:blockId:SectionId:pbsAccountId:searchAccount').value = '';
			        
			        if (document.getElementById('pgId:formId:blockId:SectionId:pbsContactId:ContactId') != null) {
				        document.getElementById('pgId:formId:blockId:SectionId:pbsContactId:ContactId').value = '';
			        }
			        caseOppDisable();
			    } else {
			        projectType = 'candidate';
			        
			        if (document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1') != null) {
			            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1_lkwgt').href = '#';
			            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').disabled = true;
			            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:Opportunity1').value = '';
			            
				        if ({!oppRequired}) {
				            document.getElementById('pgId:formId:blockId:SectionId:oppBlock:oppReq').style.display = 'none';
				        }
		        	}
			        
			        if (document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId') != null) {
		            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').disabled = true;
		            	document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId').value = '';
				        document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseId_lkwgt').href = '#';
				        
				        if ({!caseRequired}) {
				            document.getElementById('pgId:formId:blockId:SectionId:caseBlock:caseReq').style.display = 'none';
				        }
		            }

			        //re #945
			        if (clearAccount) {
			        	document.getElementById('pgId:formId:blockId:SectionId:pbsAccountId:searchAccount').value = '';
			        }
			        
			        if (document.getElementById('pgId:formId:blockId:SectionId:pbsContactId:ContactId') != null) {
				        document.getElementById('pgId:formId:blockId:SectionId:pbsContactId:ContactId').value = '';
			        }
			    }
				            
			    //re #945
			    if (clearAccount) {
			    	setBlankAccount();
			    }
			}
        </script>
    </apex:outputPanel>
    <apex:outputPanel id="onchangePanelId">
        <script>
            function callOnChangeOnly(newValue) {
			    var oldValue = '{!JSENCODE(accName)}';
			    
			    if (newValue != oldValue) {
			        PORShowLoading();
			        setAccountId(null);
			    } else {
			        return false;
			    }
			}
        </script>
    </apex:outputPanel>
    <apex:pageMessage summary="{!$Label.Insufficient_Privileges}" strength="3" severity="Info" rendered="{!IF(isFullLicenseAccessible,NOT(IsPageAccessible),isFullLicenseAccessible)}" />
    <apex:pageMessage summary="{!$Label.User_License}" strength="3" severity="Info" rendered="{!NOT(isFullLicenseAccessible)}" />
    <!-- Form -->
    <apex:form id="formId" rendered="{!AND(IsPageAccessible,isFullLicenseAccessible)}">
        <apex:sectionHeader title="{!$Label.New_Project}" subtitle="{!$Label.Customer_Reference_Project}"/>
        <apex:actionFunction name="jsFindReferenceStatus" oncomplete="PORHideLoading();"  immediate="true" action="{!getReferenceStatus}" rerender="jsPanel">
            <apex:param assignTo="{!selectedContact}" value="" name="paramName"/>
        </apex:actionFunction>
        <apex:actionFunction name="setBlankAccount" action="{!setBlankAccountContact}" oncomplete="PORHideLoading();" reRender="opContactId, opAccountId,onchangePanelId,jsPanel"/>
        <apex:actionFunction name="setAccountId" action="{!setAccountID}" oncomplete="PORHideLoading();" reRender="pgmsgId,conListId, opContactId, opAccountId,onchangePanelId,jsPanel">
            <apex:param assignTo="{!tempRef.Account__c}" value="" name="paramName"/>
        </apex:actionFunction>
        <apex:outputPanel id="conListId">
        	<apex:pageMessage summary="There are more than 1000 records to display in the Contact picklist, first 1000 records are displayed." strength="3" severity="Info" rendered="{!isLimitExceeded}" />
        </apex:outputPanel>
        <apex:pageBlock id="blockId" title="{!$Label.Information}" mode="edit">
            <apex:pageBlockButtons >
                <apex:commandButton value="{!$Label.Save}" action="{!saveContent}" onClick="return showPopup();"/> 
                <apex:commandButton value="{!$Label.Cancel}" immediate="true" action="{!cancel}"/>
            </apex:pageBlockButtons>
            
            <apex:pageBlockSection id="SectionId" columns="1">
                <apex:pageBlockSectionItem id="projectType" helpText="{!$ObjectType.Reference_Request__c.fields.Project_Type__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request__c.fields.Project_Type__c.Label}" />
                    <apex:outputPanel layout="block">
                        <apex:selectRadio value="{!projectType}" id="selectprojectType" onchange="PORShowLoading();changeProject(this.value, true);return false;">
                            <apex:selectOptions value="{!options}"/>
                        </apex:selectRadio>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem helpText="{!$ObjectType.Reference_Request__c.fields.Title__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request__c.fields.Title__c.Label}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                    	<apex:outputPanel rendered="{!subjectRequired}" styleClass="requiredBlock"></apex:outputPanel>
                        <apex:inputField id="subjectId" value="{!refReqObject.Title__c}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem id="refType" helpText="{!$ObjectType.Reference_Request_Account__c.fields.Reference_Type_Needed__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account__c.fields.Reference_Type_Needed__c.Label}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                        <div class="requiredBlock"></div>
                        <apex:selectList size="1" value="{!refReqAccountObject.Reference_Type_Needed__c}" id="selectRefType" style="width:250px">
                            <apex:selectOptions value="{!referenceabilityTypes}"/>
                        </apex:selectList>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem id="oppBlock" helpText="{!$ObjectType.Reference_Request__c.fields.Opportunity__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request__c.fields.Opportunity__c.Label}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                    	<apex:outputPanel rendered="{!oppRequired}" layout="block" styleClass="requiredBlock" id="oppReq"></apex:outputPanel>
                        <apex:inputField id="Opportunity1" value="{!refReqObject.Opportunity__c}" onchange="disableOppCase(this.value, 'Opportunity1');return false;"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                 
                <apex:pageBlockSectionItem id="caseBlock" helpText="{!$ObjectType.Reference_Request__c.fields.Case__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request__c.fields.Case__c.Label}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                    	<apex:outputPanel rendered="{!caseRequired}" layout="block" styleClass="requiredBlock" id="caseReq"></apex:outputPanel>
                        <apex:inputField id="caseId" value="{!refReqObject.Case__c}" onchange="disableOppCase(this.value, 'caseId');return false;"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                 
                <apex:pageBlockSectionitem id="pbsAccountId" helpText="{!$ObjectType.Reference_Request_Account__c.fields.Account__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account__c.fields.Account__c.label}"/>
                    <apex:outputPanel id="opAccountId">
                        <apex:actionRegion >
                            <div style="float:left" class="requiredInput">
                            	<apex:outputPanel rendered="{!accountRequired}" styleClass="requiredBlock"></apex:outputPanel>
                                <apex:inputText id="searchAccount" value="{!accName}" style="width:170px;" onchange="callOnChangeOnly(this.value);"/>&nbsp;
                            </div>
                            <div style="float:left">
                                <apex:image url="{!$Resource.lookupIconImage}" height="20px" width="20px" style="cursor:pointer;" onclick="ShowLookup('pgId:formId:blockId:SectionId:pbsAccountId:searchAccount');"/>
                            </div>
                        </apex:actionRegion>
                    </apex:outputPanel>
                </apex:pageBlockSectionitem>
                <apex:pageBlockSectionItem id="pbsContactId" helpText="{!$ObjectType.Reference_Request_Account_Contact__c.fields.Contact__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account_Contact__c.fields.Contact__c.Label}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block" id="opContactId">
                    	<apex:outputPanel rendered="{!contactRequired}" styleClass="requiredBlock"></apex:outputPanel>
                        <apex:selectList size="1" value="{!refReqAccContactObject.Contact__c}" id="ContactId" onchange="PORShowLoading();jsFindReferenceStatus(this.value);">
                            <apex:selectOptions value="{!associatedContacts}"/>                 
                        </apex:selectList>
                        
                        <script>
                            var isAccountSelected = {!isAccountSelected};
                            var isAccountReferenceable = {!accountReferenceability};
                            var isAccountCandidate = {!accCandidate};
                        </script>
                       
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem helpText="{!$ObjectType.Reference_Request_Account__c.fields.Request_Notes__c.inlineHelpText}">
                    <apex:outputLabel value="{!$Label.Notes}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                    	<apex:outputPanel rendered="{!noteRequired}" styleClass="requiredBlock"></apex:outputPanel>
                        <apex:inputField id="Comment" value="{!refReqAccountObject.Request_Notes__c}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem helpText="{!$ObjectType.Reference_Request_Account__c.fields.Deadline__c.inlineHelpText}">
                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account__c.fields.Deadline__c.Label}" />
                    <apex:outputPanel styleClass="requiredInput" layout="block">
                        <div class="requiredBlock"></div>
                        <apex:inputField id="ActivityDate" value="{!refReqAccountObject.Deadline__c}"/>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
        </apex:pageBlock>
    </apex:form>
</apex:page>