<!--
 * ReferenceEdge
 * 
 * Point of Reference, Inc. - Copyright 2014 All rights reserved.
 *
 * @company : Point of Reference, Inc.
 * @website : www.point-of-reference.com
 *
 * Disclaimer: THIS SOFTWARE IS PROVIDED "AS-IS" BY POINT OF REFERENCE ("POR"), 
 * WITH NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, 
 * EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
 * POR SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, 
 * MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES. POR IS NOT LIABLE FOR, 
 * AND MAKES NO REPRESENTATIONS OR WARRANTIES REGARDING, THE ACTIONS OR OMISSIONS OF 
 * ANY THIRD PARTIES (OR THE PRODUCTS OR SERVICES OFFERED BY ANY THIRD PARTIES) INCLUDING, 
 * WITHOUT LIMIATION, SALESFORCE.COM. COPY, USE OR DISTRIBUTION PROHIBITED WITHOUT EXPRESS 
 * WRITTEN CONSENT FROM COMPANY.
 -->
<apex:page controller="ReferenceUseRequest" sidebar="false">
    <!-- Message -->
    <apex:pageMessages id="msgId"/>
    <apex:pageMessage summary="{!$Label.User_License}" strength="3" severity="Info" rendered="{!NOT(isFullLicenseAccessible)}" />
    
    <!-- Add POR_ModalLoader Component-->
    <c:POR_ModalLoader id="PORLoader"/>
   
    <!-- Sction Header-->
    <apex:sectionHeader title="{!$Label.RF_Filters}" rendered="{!isFullLicenseAccessible}"/>
   
    <!-- Add JavaScript & Jquery-->
    <script language="javascript" type="text/javascript">
        jQuery(".content img").css("background-image","none");
        jQuery(".content img").attr("src","{!URLFOR($Resource.RESearchFilterIcons, 'filter-icon.png')}");
    </script>
   
    <!-- Add CSS-->
    <style type="text/css">

        /* ---------------------- Div width -------------------------- */
        .attributeDiv { 
            width:1000px;
        }

        /* ----------Change width here for item container------------- */
        #attributeUl li { 
            display:-moz-inline-box; -moz-box-orient:vertical;
            display:inline-block; vertical-align:top; 
            word-wrap:break-word; 
        }
        
        .rightImage {
            display:inline-block; width:15px;
        }                   
        
        /* ----------Change width here for item container------------- */
        .attributeDiv div { 
            width:950px; 
            float:left;
            //border : 1px solid black;
        }
        
        /* ----------Change item width here -------------------------- */
        #attributeUl li > * { 
            //display:table; 
            table-layout:fixed; 
            width:250px; 
            overflow:hidden; 
            
        }
        
        /* ----------------- Item text aliment ----------------------- */
        .attributeDiv li { 
            color:#333; 
            text-align:left;
        }
        
        .attributeUl  { 
             //display:table; 
             table-layout:fixed; 
             width:250px; 
             overflow:hidden; 
             float : left;
             list-style-type: none;
         }
        
    </style>
    <script>
        PORShowLoading();
        jQuery(window).load(function() {
            
            //REF-2366
            if ('{!isFromAttributeResults}' == 'true') {
                //Attribute labels
                var mapLabelIdattributeLabelsInAttributeResults = JSON.parse(localStorage.getItem('mapLabelIdattributeLabelsInAttributeResults'));
                var mapLabelIdattributeLabelsInAttributeResultsString = '';
                
                if (mapLabelIdattributeLabelsInAttributeResults != null) {
                    mapLabelIdattributeLabelsInAttributeResultsString = JSON.stringify(mapLabelIdattributeLabelsInAttributeResults);
                }
                
                //Attributes in Attribute Results
                var mapLabelIdAttributesInAttributeResults = JSON.parse(localStorage.getItem('mapLabelIdAttributesInAttributeResults'));
                var mapLabelIdAttributesInAttributeResultsString = '';
                
                if (mapLabelIdAttributesInAttributeResults != null) {
                    var mapLabelIdAttributesInAttributeResultsString = JSON.stringify(mapLabelIdAttributesInAttributeResults);
                }
                
                //Attributes in SelectReferenceUseAttribute
                var mapLabelIdAttributesInSelectRefUseAttr = JSON.parse(localStorage.getItem('mapLabelIdAttributesInSelectRefUseAttr'));
                var mapLabelIdAttributesInSelectRefUseAttrString = '';
                
                if (mapLabelIdAttributesInSelectRefUseAttr != null) {
                    mapLabelIdAttributesInSelectRefUseAttrString = JSON.stringify(mapLabelIdAttributesInSelectRefUseAttr);
                }
                
                var resetVariables = JSON.parse(localStorage.getItem('resetVariables'));
                
                if (resetVariables != null && resetVariables.length > 0) {
                    resetAll(resetVariables[0],resetVariables[1],resetVariables[2],resetVariables[3],resetVariables[4],
                             resetVariables[5],resetVariables[6],mapLabelIdattributeLabelsInAttributeResultsString,
                             mapLabelIdAttributesInAttributeResultsString,mapLabelIdAttributesInSelectRefUseAttrString,resetVariables[7],resetVariables[8]);
                } else {
                    PORHideLoading();
                }
            } else {      
                localStorage.clear();
                //REF-2653
                setPreviouslySelectedAttributes();
            }
            
        });
    
    //REF-2366
    function goToAttributeResultsPage(labelId) {
        PORShowLoading();
        
        //save variables to come back to the same instance
        if ('{!isFromAttributeResults}' != 'true') {
            var resetVariables = [];
            resetVariables.push('{!JSENCODE(param1)}');
            resetVariables.push('{!JSENCODE(param2)}');
            resetVariables.push('{!JSENCODE(param3)}');
            resetVariables.push('{!JSENCODE(param4)}');
            resetVariables.push('{!JSENCODE(selectedValue)}');
            resetVariables.push('{!JSENCODE(oldReferenceability)}');
            resetVariables.push('{!JSENCODE(recordCounts)}');
            resetVariables.push('{!JSENCODE(mapRBIIdReferenceUseInstanceWrapperString)}');
            resetVariables.push('{!JSENCODE(refTypeIdSetString)}');
            localStorage.setItem('resetVariables', JSON.stringify(resetVariables));
        }
        goToAttributeResults(labelId);
    }
    
    function setSelectedAttributes(labelId, attributeId) {
        var mapLabelIdAttributeIds = JSON.parse(localStorage.getItem('mapLabelIdAttributesInSelectRefUseAttr'));
        
        if (mapLabelIdAttributeIds == null) {
            mapLabelIdAttributeIds = {};
        }
        
        if (mapLabelIdAttributeIds[labelId] == undefined) {
            mapLabelIdAttributeIds[labelId] = [];
        }
        
        if (mapLabelIdAttributeIds[labelId].indexOf(attributeId) == -1) {
            mapLabelIdAttributeIds[labelId].push(attributeId);
        } else {
            mapLabelIdAttributeIds[labelId].splice(mapLabelIdAttributeIds[labelId].indexOf(attributeId),1);
        }
        
        localStorage.setItem('mapLabelIdAttributesInSelectRefUseAttr', JSON.stringify(mapLabelIdAttributeIds));
        selectAttribute(labelId,attributeId);
    }
    </script>

    <apex:outputPanel id="localScript">
        <script>
        //REF-2653
        function storePreviouslySelectedAttributes() {
            var mapAttributeLabelString = '{!refUseAttr.mapPreviouslySelectedFilterAttributeString}';
            var mapAttributeLabel = JSON.parse(mapAttributeLabelString);
            
            if (mapAttributeLabel['bulkFilter'] != null) {
                var mapLabelAtributes = mapAttributeLabel['bulkFilter'];
                var mapLabelAtributeLabels = mapAttributeLabel['bulkFilterAttributeLabel'];
                var mapLabelIdAttributesInAttributeResults = JSON.parse(localStorage.getItem('mapLabelIdAttributesInAttributeResults'));
                var mapLabelIdAttributeLabelsInAttributeResults = JSON.parse(localStorage.getItem('mapLabelIdattributeLabelsInAttributeResults'));
                
                if (mapLabelIdAttributesInAttributeResults != null) {
                    var tempKeys = Object.keys(mapLabelAtributes);
                    
                    for (let  i=0; i < tempKeys.length; i++) {
                        
                        if (mapLabelIdAttributesInAttributeResults[tempKeys[i]] == undefined) {
                            mapLabelIdAttributesInAttributeResults[tempKeys[i]] = [];
                            mapLabelIdAttributeLabelsInAttributeResults[tempKeys[i]] = [];
                        }
                        
                        for (let j=0; j < mapLabelAtributes[tempKeys[i]].length; j++) {
                            mapLabelIdAttributesInAttributeResults[tempKeys[i]].push(mapLabelAtributes[tempKeys[i]][j]);
                            mapLabelIdAttributeLabelsInAttributeResults[tempKeys[i]].push(mapLabelAtributeLabels[tempKeys[i]][j]);
                        }
                    }
                    localStorage.setItem('mapLabelIdAttributesInAttributeResults', JSON.stringify(mapLabelIdAttributesInAttributeResults));   
                    localStorage.setItem('mapLabelIdattributeLabelsInAttributeResults', JSON.stringify(mapLabelIdAttributeLabelsInAttributeResults));
                } else {
                    localStorage.setItem('mapLabelIdAttributesInAttributeResults', JSON.stringify(mapAttributeLabel['bulkFilter']));
                    localStorage.setItem('mapLabelIdattributeLabelsInAttributeResults', JSON.stringify(mapAttributeLabel['bulkFilterAttributeLabel']));
                }
            }
            
            if (mapAttributeLabel['filter'] != null) {
                var mapLabelAtributes = mapAttributeLabel['filter'];
                var mapLabelIdAttributesInAttributeResults = JSON.parse(localStorage.getItem('mapLabelIdAttributesInSelectRefUseAttr'));
                
                if (mapLabelIdAttributesInAttributeResults != null) {
                    var tempKeys = Object.keys(mapLabelAtributes);
                    
                    for (let  i=0; i < tempKeys.length; i++) {
                        
                        if (mapLabelIdAttributesInAttributeResults[tempKeys[i]] == undefined) {
                            mapLabelIdAttributesInAttributeResults[tempKeys[i]] = [];
                        }
                        
                        for (let j=0; j < mapLabelAtributes[tempKeys[i]].length; j++) {
                            mapLabelIdAttributesInAttributeResults[tempKeys[i]].push(mapLabelAtributes[tempKeys[i]][j]);
                        }
                    }
                    localStorage.setItem('mapLabelIdAttributesInSelectRefUseAttr', JSON.stringify(mapLabelIdAttributesInAttributeResults));    
                } else {
                    localStorage.setItem('mapLabelIdAttributesInSelectRefUseAttr', JSON.stringify(mapAttributeLabel['filter']));
                }
            }
        }
        </script>
    </apex:outputPanel>
    
    <!-- Form -->    
    <apex:form id="frmId" rendered="{!isFullLicenseAccessible}">
        <!-- REF-2653 -->
        <apex:actionFunction name="setPreviouslySelectedAttributes" reRender="opAttributes,localScript" action="{!refUseAttr.setPreviouslySelectedAttributes}"
                             immediate="false" oncomplete="PORHideLoading();storePreviouslySelectedAttributes();" />
        <!-- Action Fuctions for Attribute-->  
        <apex:actionFunction name="selectAttribute" reRender="opAttributes" action="{!refUseAttr.setAttributes}" immediate="false" oncomplete="PORHideLoading();">
            <apex:param name="selectedLabelId" value="" assignTo="{!refUseAttr.selectedLabelId}"/>
            <apex:param name="selectedAttrId" value="" assignTo="{!refUseAttr.selectedAttributeId}"/>
        </apex:actionFunction>
        <!-- REF-2366 -->
        <apex:actionFunction name="goToAttributeResults" action="{!goToAttributeResults}" immediate="false" oncomplete="PORHideLoading();">
            <apex:param name="para1" value="" assignTo="{!selectedLabelId}"/>
        </apex:actionFunction>
        <apex:actionFunction name="resetAll"  immediate="true" action="{!setPreviousInstanceOfPage}" oncomplete="PORHideLoading();" reRender="opAttributes">
            <apex:param name="p1" assignTo="{!param1}" value="" />
            <apex:param name="p2" assignTo="{!param2}" value="" />
            <apex:param name="p3" assignTo="{!param3}" value="" />
            <apex:param name="p4" assignTo="{!param4}" value="" />
            <apex:param name="p5" assignTo="{!selectedValue}" value="" />
            <apex:param name="p6" assignTo="{!oldReferenceability}" value=""/>
            <apex:param name="p7" assignTo="{!recordCounts}" value=""/>
            <apex:param name="p8" assignTo="{!refUseAttr.selectedAttributeLabelsIdsFromAttributeResults}" value=""/>
            <apex:param name="p9" assignTo="{!refUseAttr.labelAttributesToBeSelectedFromAttributeResults}" value=""/>
            <apex:param name="p10" assignTo="{!refUseAttr.labelAttributesToBeSelected}" value=""/>
            <apex:param name="p11" assignTo="{!mapRBIIdReferenceUseInstanceWrapperString}" value=""/>
            <apex:param name="p12" assignTo="{!refTypeIdSetString}" value=""/>
        </apex:actionFunction>
        
        <!-- Page Block -->
        <div style="float:left ; ">
            <apex:commandLink style="color:#5C95C4;" value="{!$Label.Back_to_Request_Reference_Use}" id="backCmdLinkId" action="{!refUseAttr.backToRequestOnCancel}"/>
        </div>
        <apex:pageBlock id="pbId">
        
            <apex:PageBlockSection id="pbsAttrId">
                <apex:outputPanel id="opAttributes">
                    <apex:repeat value="{!refUseAttr.AttributeLabels}" var="lbl">
                        <div class="attributeDiv">
                            <div style="text-align:left;text-indent:50px;font-size: 150%;"> 
                                {!lbl.Name} <apex:outputText style="color : #CC0000;" value="{!IF(refUseAttr.mapRequiredLabel[lbl.Id],' | ','')}"/>
                            </div>
                            
                            <div>
                                <!-- Output Panel for Attribute records REF-2366-->
                                <apex:outputPanel rendered="{!AND(refUseAttr.mapAttibuteSize[lbl] > 0,refUseAttr.mapAttibuteSize[lbl] <= 200)}"> 
                                    <ul class="attributeUl"> 
                                        <apex:variable var="rows" value="{!FLOOR(refUseAttr.mapAttibuteSize[lbl]/3) + if(MOD(refUseAttr.mapAttibuteSize[lbl],3) > 0, 1,0)}" />
                                        <apex:repeat value="{!refUseAttr.mapAllAttributesLabel[lbl]}" var="attribute" first="0" rows="{!rows}">
                                            <li>
                                            <table>
                                                <tr>
                                                    <td style="width:13px;">
                                                        <apex:image url="{!$Resource.Tick}" rendered="{!attribute.fontWeight !='normal'}" height="12px" width="12px"/>
                                                    </td>
                                                    <td style="width: 200px;">
                                                        <!-- REF-2366 -->
                                                        <apex:outputLink style="text-decoration:none;" value="#" onclick="PORShowLoading();setSelectedAttributes('{!JSENCODE(attribute.attributeLabel.Label__c)}','{!JSENCODE(attribute.attributeLabel.Attribute__c)}');return false;">
                                                           <apex:outputLabel value="{!attribute.attributeLabel.Attribute__r.Name}" style="font-weight:{!HTMLENCODE(attribute.fontWeight)};cursor:pointer;" />
                                                        </apex:outputLink>
                                                    </td>
                                                </tr>
                                            </table>
                                            </li>
                                        </apex:repeat>
                                    </ul>
                                    
                                    <ul class="attributeUl">
                                        <apex:variable var="startVal" value="{!FLOOR(refUseAttr.mapAttibuteSize[lbl]/3) + if(MOD(refUseAttr.mapAttibuteSize[lbl],3) > 0, 1,0)}" />
                                        <apex:variable var="rows" value="{!FLOOR(refUseAttr.mapAttibuteSize[lbl]/3) + if(MOD(refUseAttr.mapAttibuteSize[lbl],3) > 1, 1,0)}" /> 
                                        <apex:repeat value="{!refUseAttr.mapAllAttributesLabel[lbl]}" var="attribute" 
                                            first="{!startVal}" rows="{!rows}">
                                            <li>
                                            <table>
                                                <tr>
                                                    <td style="width:13px;">
                                                        <apex:image url="{!$Resource.Tick}" rendered="{!attribute.fontWeight !='normal'}" height="12px" width="12px"/>
                                                    </td>
                                                    <td style="width: 200px;">
                                                        <!-- REF-2366 -->
                                                        <apex:outputLink style="text-decoration:none;" value="#" onclick="PORShowLoading();setSelectedAttributes('{!JSENCODE(attribute.attributeLabel.Label__c)}','{!JSENCODE(attribute.attributeLabel.Attribute__c)}');return false;">
                                                           <apex:outputLabel value="{!attribute.attributeLabel.Attribute__r.Name}" style="font-weight:{!HTMLENCODE(attribute.fontWeight)};cursor:pointer;" />
                                                        </apex:outputLink>
                                                    </td>
                                                </tr>
                                            </table>
                                            </li>
                                        </apex:repeat>
                                    </ul>                                
                                    
                                    <ul class="attributeUl">
                                        <apex:variable var="startVal" value="{!FLOOR(refUseAttr.mapAttibuteSize[lbl]/3)*2 + if(MOD(refUseAttr.mapAttibuteSize[lbl],3) > 0, if(MOD(refUseAttr.mapAttibuteSize[lbl],3) > 1,2,1) ,0)}" />                                     
                                        <apex:repeat value="{!refUseAttr.mapAllAttributesLabel[lbl]}" var="attribute"  first="{!startVal}" rows="0">
                                            <li>
                                            <table>
                                                <tr>
                                                    <td style="width:13px;">
                                                        <apex:image url="{!$Resource.Tick}" rendered="{!attribute.fontWeight !='normal'}" height="12px" width="12px"/>
                                                    </td>
                                                    <td style="width: 200px;">
                                                        <!--REF-2366 -->
                                                        <apex:outputLink style="text-decoration:none;" value="#" onclick="PORShowLoading();setSelectedAttributes('{!JSENCODE(attribute.attributeLabel.Label__c)}','{!JSENCODE(attribute.attributeLabel.Attribute__c)}');return false;">
                                                           <apex:outputLabel value="{!attribute.attributeLabel.Attribute__r.Name}" style="font-weight:{!HTMLENCODE(attribute.fontWeight)};cursor:pointer;" />
                                                        </apex:outputLink>
                                                    </td>
                                                </tr>
                                            </table>
                                            </li>
                                        </apex:repeat>
                                    </ul>  
                                </apex:outputPanel>  
                                
                                <!--  REF-2366 Output Pannel for more than 200 records -->
                                <apex:outputPanel rendered="{!AND(refUseAttr.mapAttibuteSize[lbl] > 0,refUseAttr.mapAttibuteSize[lbl] > 200)}">
                                    <ul class="attributeUl">    
                                        <li>
                                            <apex:commandLink value="{!$Label.See_All}" onclick="goToAttributeResultsPage('{!lbl.Id}');">
                                            </apex:commandLink>
                                        </li>
                                            <apex:variable value="{!refUseAttr.mapSelectedLabelAttributesFromAttributeResult[lbl.Id]}" var="list" />
                                            <apex:repeat rendered="{!list.size > 0}" value="{!refUseAttr.mapSelectedLabelAttributesFromAttributeResult[lbl.Id]}" var="attribute">
                                                <li>
                                                    <apex:outputText value="{!attribute.attributeLabel.Attribute__r.Name}" style="font-weight:{!HTMLENCODE(attribute.fontWeight)};cursor:pointer;" />
                                                </li>
                                            </apex:repeat>
                                    </ul>
                                </apex:outputPanel>
                                
                                <!-- Output Panel for No Record found--> 
                                <apex:outputPanel rendered="{!refUseAttr.mapAttibuteSize[lbl] = 0}">                                
                                    <ul class="attributeUl">    
                                       <li>
                                           <apex:outputLabel value="{!$Label.No_Data_Found}" />
                                       </li>
                                    </ul>
                                </apex:outputPanel>
                            </div>
                            
                        </div>
                    </apex:repeat>
                </apex:outputPanel>
            </apex:PageBlockSection>
                    
            
            <!-- Page Block Buttons Top REF-2653-->
            <apex:pageBlockButtons id="pbbIdTop">
                <apex:commandButton value="{!$Label.Done}" id="doneCmdBtnId" onclick="localStorage.clear();" action="{!refUseAttr.backToRequest}"/>
                <apex:commandButton value="{!$Label.Cancel}" id="cancelCmdBtnId" onclick="localStorage.clear();" action="{!refUseAttr.backToRequestOnCancel}"/>
            </apex:pageBlockButtons>
            
        </apex:pageBlock> 
    </apex:form>
</apex:page>