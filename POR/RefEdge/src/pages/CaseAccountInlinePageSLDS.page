<!--
* ReferenceEdge
* 
* Point of Reference, Inc. - Copyright 2014 All rights reserved.
*
* @company : Point of Reference, Inc.
* @website : www.point-of-reference.com
*
* Disclaimer: THIS SOFTWARE IS PROVIDED "AS-IS" BY POINT OF REFERENCE ("POR"), 
* WITH NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, 
* EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
* POR SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, 
* MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES. POR IS NOT LIABLE FOR, 
* AND MAKES NO REPRESENTATIONS OR WARRANTIES REGARDING, THE ACTIONS OR OMISSIONS OF 
* ANY THIRD PARTIES (OR THE PRODUCTS OR SERVICES OFFERED BY ANY THIRD PARTIES) INCLUDING, 
* WITHOUT LIMIATION, SALESFORCE.COM. COPY, USE OR DISTRIBUTION PROHIBITED WITHOUT EXPRESS 
* WRITTEN CONSENT FROM COMPANY.
-->
<apex:page standardController="Case"
           showHeader="false"
           standardStylesheets="false"
           extensions="SLDSAccountLevelRULController"
           sidebar="false"
           applyHtmlTag="false"
           applyBodyTag="false"
           docType="html-5.0">
 <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <head>
            <apex:stylesheet value="{!URLFOR($Resource.LightningCSS_2_3, 'assets/styles/custom-slds.css')}" />   
            <script src="{!URLFOR($Resource.JqueryFiles, 'jquery-1.8.3.js')}"/>
            <script src="{!URLFOR($Resource.AngularJS)}">
            </script>
            <apex:stylesheet value="{!URLFOR($Resource.Font, 'font-awesome-4.5.0/css/font-awesome.min.css')}" />
            <script src="{!URLFOR($Resource.MomentJS)}"></script>
            <c:LookupPicklistSLDS id="picklistId"/>
            <apex:includeScript value="/support/console/44.0/integration.js" />

            <style type="text/css">
                .bPageHeader {
                display:none;
                }
                .slds {
                    font: 100% / 1.5 "Salesforce Sans", Arial, sans-serif !important;
                    font-style: normal;
                    font-variant-ligatures: normal;
                    font-variant-caps: normal;
                    font-variant-numeric: normal;
                    font-variant-east-asian: normal;
                    font-weight: normal;
                    font-stretch: normal;
                    font-size: 100%;
                    line-height: 1.5;
                    font-family: "Salesforce Sans", Arial, sans-serif !important;
                    background: white;
                    color: #16325c;
                    -webkit-tap-highlight-color: transparent;
                }
                .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox_faux:after, .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox--faux:after, .slds-checkbox [type="checkbox"][disabled] ~ .slds-checkbox_faux:after, .slds-checkbox [type="checkbox"][disabled] ~ .slds-checkbox--faux:after, .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox__label .slds-checkbox_faux:after, .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox__label .slds-checkbox--faux:after {
					border-color: #7d8894!important; 
				}
                .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox_faux, .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox--faux, .slds-checkbox [type="checkbox"][disabled] ~ .slds-checkbox_faux, .slds-checkbox [type="checkbox"][disabled] ~ .slds-checkbox--faux, .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox__label .slds-checkbox_faux, .slds-checkbox [type="checkbox"][disabled] + .slds-checkbox__label .slds-checkbox--faux {
                    background-color: white!important;
                }
                .slds .slds-checkbox [type="checkbox"][disabled] > .slds-checkbox--faux:after, .slds .slds-checkbox [type="checkbox"][disabled] ~ .slds-checkbox--faux:after{
                    border-color : gray;
                    }
                    a {
                    cursor: pointer;
                }
                #error-block {
                background-color: #DA4949;
                color: WHITE;
                font-size: 15px;
                border-radius: 5px;
                }
                .slds-form-element__static{
                font-size: 13px !important;
                }
                .tooltipHelpShow:before {
					left: 103px!important;
				}
				.tooltipHelpShow:after {
					left: 103px!important;
				}
                .tooltip:hover .tooltipHelpShow {
				    display : inline;
                    bottom: 65px;
                    position: absolute;
                    margin-left:-80px;
                    min-width: 50%;
                    max-width: 70%;
				}
				.tooltip:hover .tooltipHelpHide {
				    display : none;
                    bottom: 65px;
                    position: absolute;
				}

				.tooltipHelpShow {
				    display : none;
                    bottom: 65px;
                    line-height: 0.95rem;
                    position: absolute;
                    margin-left:-80px;
                    min-width: 50%;
                    max-width: 70%;
				}
				.tooltipHelpHide {
				    display : inline;
                    bottom: 65px;
                    position: absolute;
				}
            </style>
            
            <script>
            var myApp = angular.module('myApp', ['lookupPicklistApp']);
            
            myApp.controller('myCtrl', function ($scope, $window, $q) {
                
                $scope.RBI;
                $scope.caseId = '{!Case.Id}';
                $scope.accountId = '';
                $scope.nameSpace = '{!JSENCODE(nameSpace)}';
                $scope.lastSectionHeader = '';
                $scope.errMsg = '';
                $scope.isEditEnabled = false;
                $scope.isUpdate = false;
                $scope.objectName = 'User';
                $scope.isAccountExist = true;
                $scope.infoFields = [];
                $scope.limitFields = [];
                $scope.rewardFields = [];
                $scope.summaryFields = {};
                $scope.oldInactiveReason = '';
                $scope.oldRefStatus = '';
                $scope.isShowSummary = false;
                $scope.isHidden = false;
                $scope.showRefMsg = false;
                $scope.showAttMsg = false;
                $scope.redirectToRef = false;
                $scope.redirectToAtt = false;
                $scope.referenceabilityStatus = 'Referenceability_Status__c';
                $scope.inactiveReason = 'Inactive_Reason__c';
                $scope.referenceOwner = 'Reference_Owner__c';
                $scope.refTypes = [];
                $scope.showTotalRefs = false;
                $scope.showConfirmation = false;
                $scope.confirmMsg = '';
                
                $scope.preInit = function () {
                		$scope.getAccount().then(function(result) {
                			if (result != null) {
                        		$scope.accountId = result;
                        		$scope.init();
                			} else {
                        		$scope.isAccountExist = false;
                        }
                		});
                }
                $scope.init = function () {
                		
                    $scope.fetchRBI().then(function(result) {
                    		
                        if (result != null) {
                        		$scope.RBI = result;
                                $scope.typeOld = $scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] ? 'Member' : $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c'] ? 'Candidate' : '';
                            if ($scope.RBI.Id != null) {
                                $scope.isUpdate = true;
                            }
                            
                            if ($scope.RBI[$scope.nameSpace + $scope.referenceabilityStatus] == 'Inactive') {   
	                        		$scope.isHidden = false;
	                    		} else {
	                        		$scope.isHidden = true;
	                    		} 
                    		
                            if ($scope.RBI[$scope.nameSpace + $scope.inactiveReason] != null) {
                                $scope.oldInactiveReason = $scope.RBI[$scope.nameSpace + $scope.inactiveReason];
                            }
                            
                            if ($scope.RBI[$scope.nameSpace + $scope.referenceabilityStatus] != null) {
                                $scope.oldRefStatus = $scope.RBI[$scope.nameSpace + $scope.referenceabilityStatus];
                            }
                            
                            $scope.showTotalReferenceUses().then(function(resultNew) {
                            	
	                            	if (resultNew != null) {
	                            		$scope.refTypes = resultNew;
	                            	}
	                            });
                            $scope.isEditEnabled = (({!$ObjectType.Reference_Basic_Information__c.updateable} && $scope.RBI.Id != null) 
                                                    || ({!$ObjectType.Reference_Basic_Information__c.createable} && $scope.RBI.Id == null));
                        } 
                    });
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getInfoFields}', 
                        $scope.accountId,
                        function(result, event) {
                            if (result != null) {
                                result = $scope.parseResult(result);
                                $scope.$apply(function () {
                                    $scope.infoFields = JSON.parse(result);  
                                    $scope.isInformationSection = true;
                                });
                            }
                        },
                        {escape: true}
                    );
                    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getLimitFields}', 
                        $scope.accountId,
                        function(result, event) {
                            if (result != null) {
                                result = $scope.parseResult(result);
                                $scope.$apply(function () {
                                    $scope.limitFields = JSON.parse(result);
                                    $scope.isUseLimitSection = true;
                                });
                            }
                        },
                        {escape: true}
                    );
                    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getRewardFields}', 
                        $scope.accountId,
                        function(result, event) {
                            if (result != null) {
                                result = $scope.parseResult(result);
                                $scope.$apply(function () {
                                    $scope.rewardFields = JSON.parse(result);
                                    $scope.isRewardSection = true;
                                });
                            }
                        },
                        {escape: true}
                    );
                    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getSummaryFields}', 
                        function(result, event) {
                            if (result != null) {
                                result = $scope.parseResult(result);
                                $scope.$apply(function () {                                	
                                	$scope.summaryField = JSON.parse(result);
                                    $scope.isShowSummary = true;
                                });
                            }
                        },
                        {escape: true}
                    );
                    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getPickList}',
                        function(result, event) {
                            result = $scope.parseResult(result);
                            if (result != null) {
                                $scope.$apply(function () {
                                    $scope.selectOptions = JSON.parse(result);
                                });
                            }
                        },
                        {escape: true}
                    );
                    
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getLastSectionHeader}',
                        function(result, event) {
                            if (result != null) {
                                $scope.$apply(function () {
                                    $scope.lastSectionHeader = result;
                                });
                            }
                        },
                        {escape: true}
                    );
                }
                $scope.getAccount = function() {
                    var deferred = $q.defer();
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getAccountId}',
                        $scope.caseId,
                        function(result, event) {
                            deferred.resolve(result);
                        },
                        {escape: true}
                    );
                    return deferred.promise;
                }
                
                $scope.checkPermission = function() {
                    var deferred = $q.defer();
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getPermissionsMessage}',
                        $scope.isUpdate,
                        function(result, event) {
                            deferred.resolve(result);
                        },
                        {escape: true}
                    );
                    return deferred.promise;
                }
                
                $scope.showTotalReferenceUses = function() {
                    var deferred = $q.defer();
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.showTotalReferenceUses}',
                        $scope.accountId,
                        function(result, event) {
                            deferred.resolve(result);
                        },
                        {escape: true}
                    );
                    return deferred.promise;
                }
                
                $scope.fetchRBI = function() {
                    var deferred = $q.defer();
                    Visualforce.remoting.Manager.invokeAction(
                        '{!$RemoteAction.SLDSAccountLevelRULController.getRBI1}',
                        $scope.accountId,
                        function(result, event) {
                            deferred.resolve(result);
                        },
                        {escape: true}
                    );
                    return deferred.promise;
                }
                
                $scope.editRBI = function() {
                    $scope.isEdit = true;
                }
                
                $scope.cancelRBI = function() {
                    $scope.isEdit = false;
                    $scope.isError = false;
                    $scope.fetchRBI().then(function(result) {
                        if (result != null) {
                            $scope.RBI = result;
                            $scope.typeOld = $scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] ? 'Member' : $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c'] ? 'Candidate' : '';
                        }
                    });
                }
                
                //re #859 to check the condition to show the popup or not
                $scope.saveRBIPopup = function() { 
                	
                	if (true) {
                		$scope.showRefMsg = true;
                	} else {
                		$scope.saveRBI(false);
                	}
                }
                
                //re #859 to redirecting to add ref type page
                $scope.gotoRefPage = function() {
                	$scope.redirectToRef = true;
                	$scope.saveRBI(false);
                }
                
                //re #859 to redirecting to add attribute page
                $scope.gotoAttPage = function() {
                	$scope.redirectToAtt = true;
                	$scope.saveRBI(false);
                }
                
                $scope.saveRBI = function(isFromConfirm) { 
                    
                    if (!isFromConfirm) {
                        $scope.showRefMsg = false;
                        $scope.showAttMsg = false;
                        $scope.showConfirmation = false;
                	
                        //Check for inactive resason
                        if ($scope.RBI[$scope.nameSpace + $scope.referenceabilityStatus] == 'Inactive' && ($scope.RBI[$scope.nameSpace + $scope.inactiveReason] == null || $scope.RBI[$scope.nameSpace + $scope.inactiveReason] == '' || $scope.RBI[$scope.nameSpace + $scope.inactiveReason].trim().length == 0)) {
                            $scope.isError = true;
                            $scope.errMsg = 'Please Provide the Inactive reason.';
                        } else {
                            $scope.isError = false;
                        }  
                        
                        if (!$scope.isError) { 
                            $scope.checkPermission().then(function(result) {
                                
                                if (result != '') {
                                    $scope.isError = true;
                                    $scope.errMsg = result;
                                } else {
                                    $scope.isError = false;
                                }
                                
                                if (!$scope.isError) {
                                   var typeNew = $scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] ? 'Member' : $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c'] ? 'Candidate' : '';
                                    
                                    if (!($scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] && $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c']) && $scope.typeOld != '' && typeNew != '' && typeNew != $scope.typeOld && $scope.typeOld == 'Member' ) {
                                        $scope.showConfirmation = true;
                                        $scope.confirmMsg = '{!$Label.Member_to_Candidate_confirm}';
                                    } else if ((!($scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] && $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c'])) && $scope.typeOld != '' && typeNew != '' && typeNew != $scope.typeOld && $scope.typeOld == 'Candidate' ) {
                                        $scope.showConfirmation = true;
                                        $scope.confirmMsg = '{!$Label.Candidate_to_Member_confirm}';
                                    } else {
                                        Visualforce.remoting.Manager.invokeAction(
                                            '{!$RemoteAction.SLDSAccountLevelRULController.saveRBIRecords}',
                                                JSON.stringify($scope.RBI), $scope.oldInactiveReason, $scope.oldRefStatus, 
                                            function(result, event) {
                                                if (result != null) {
                                                    result = $scope.parseResult(result);
                                                    $scope.$apply(function() {
                                                        if (result.startsWith('Error') == false) {
                                                            $scope.isError = false;
                                                            $scope.isEdit = false;
                                                            $scope.RBI = JSON.parse(result);
                                                            $scope.typeOld = $scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] ? 'Member' : $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c'] ? 'Candidate' : '';
                                                            
                                                            if ($scope.redirectToRef) {
                                                                redirectToURL('{!$Page.AddNewReferenceability}?accountRBI=' + $scope.accountId);
                                                            } else if ($scope.redirectToAtt) {
                                                                redirectToURL('{!$Page.AddLabelAttributesPage}?Id=' + $scope.accountId);
                                                            } else {
                                                                
                                                                redirectToBack($scope.caseId);	                                            
                                                            }
                                                        } else {
                                                            result = result.replace(/&#39/g, '\'');
                                                            $scope.errMsg = result.substring(5);
                                                            $scope.isError = true;
                                                        }
                                                    });
                                                }
                                            },
                                            {escape: true}
                                        );
                                    }
                                }
                            });
                        }
                    } else {
                        $scope.showConfirmation = false;
                    
                        Visualforce.remoting.Manager.invokeAction(
                            '{!$RemoteAction.SLDSAccountLevelRULController.saveRBIRecords}',
                                JSON.stringify($scope.RBI), $scope.oldInactiveReason, $scope.oldRefStatus, 
                            function(result, event) {
                                if (result != null) {
                                    result = $scope.parseResult(result);
                                    $scope.$apply(function() {
                                        if (result.startsWith('Error') == false) {
                                            $scope.isError = false;
                                            $scope.isEdit = false;
                                            $scope.RBI = JSON.parse(result);
                                            $scope.typeOld = $scope.RBI[$scope.nameSpace + 'Is_Referenceable__c'] ? 'Member' : $scope.RBI[$scope.nameSpace + 'Reference_Program_Candidate__c'] ? 'Candidate' : '';
                                            
                                            if ($scope.redirectToRef) {
                                                redirectToURL('{!$Page.AddNewReferenceability}?accountRBI=' + $scope.accountId);
                                            } else if ($scope.redirectToAtt) {
                                                redirectToURL('{!$Page.AddLabelAttributesPage}?Id=' + $scope.accountId);
                                            } else {
                                                
                                                redirectToBack($scope.caseId);	                                            
                                            }
                                        } else {
                                            result = result.replace(/&#39/g, '\'');
                                            $scope.errMsg = result.substring(5);
                                            $scope.isError = true;
                                        }
                                    });
                                }
                            },
                            {escape: true}
                        );
                    }
                }
				
                $scope.parseResult = function(result) {
                    if (result != null) {
                        result = result.replace(/&quot/gi, '"');
                        result = result.replace(/&amp/g, '&');
                        result = result.replace(/&lt/g, '<');
                        result = result.replace(/&gt/g, '>');
                        result = result.replace(/&#39/g, '\'');
                        result = result.replace(/;/g, '');
                        return result;
                    }
                }
                
                $scope.openModal = function() {
                    $scope.showModal = true;
                }
                
                $scope.saveModal = function() {
                    $scope.showModal = false;
                    $scope.saveRBI(false);
                }
                
                $scope.cancelModal = function() {
                    $scope.showModal = false;
                    $scope.fetchRBI();
                }
                
                /*Method used to show/hide Inactive Reason */
                $scope.statusChanged = function(field){
                    
                    if (field == 'Inactive') {   
                        $scope.isHidden = false;
                    } else {
                        $scope.isHidden = true;
                    }
                }
            });
            
            var redirectionUrl;

            function openUrl(result) {
                var primaryTabId = result.id;
                sforce.console.openSubtab(primaryTabId, redirectionUrl, true, null, null, null, null);
            }

            //regarding #840
            function redirectToBack(caseId) {                

                if ((typeof sforce != 'undefined') && sforce != null && !sforce.console.isInConsole()) {
                    sforce.one.navigateToSObject(caseId, 'detail');
                }
            }
            //re #859
            function redirectToURL(url) {
                redirectionUrl = url;

                if ((typeof sforce != 'undefined') && sforce != null && sforce.console.isInConsole()) {
                    sforce.console.getEnclosingPrimaryTabId(openUrl);
                } else if ((typeof sforce != 'undefined') && sforce != null) {
                    sforce.one.navigateToURL(url, true);
                }
            }
            </script>
        </head>
        
        <body class="slds">
            <div>
                <div>
                    <div class="slds-m-horizontal--xx-small">
                        <form id="frmId">
                        		
                            <div ng-app="myApp" ng-controller="myCtrl" ng-cloak="ng-cloak" ng-init="preInit();">
	                        		<div ng-show="!isAccountExist">
				                      <svg class="slds-icon slds-icon-action-call slds-icon--large slds-p-around--x-small">
				                          <use xlink:href="{!URLFOR($Resource.LightningCSS,'/assets/icons/utility-sprite/svg/symbols.svg#info')}"></use>
				                      </svg>
				                      {!$Label.NoAccountCase}
				                </div>
                                <div class="slds-page-header__detail-row" style="margin:0;padding:1vh" role="banner"  ng-show="isAccountExist">
                                    <div class="slds-grid">
                                        <div class="slds-col">
                                            <div><apex:image url="{!$Resource.RefEdgeLogo}" style="width:80%;float:left;"/></div>
                                        </div>
                                        <div class="slds-col slds-no-flex slds-align-middle">
                                            <a ng-click="editRBI()" ng-show="!isEdit && isEditEnabled" class="slds-button slds-button--neutral">{!$Label.Edit}</a>
                                            <a ng-click="cancelRBI()" ng-show="isEdit" class="slds-button slds-button--neutral">{!$Label.Cancel}</a>
                                            <a ng-click="saveRBI(false)" ng-show="isEdit" class="slds-button slds-button--brand">{!$Label.Save}</a>
                                        </div>
                                    </div>
                                </div>
                                <div id="error-block" ng-show="isError" class="slds-p-around--small">
                                    <strong>
                                        {!$Label.Please_review_the_following_errors}
                                    </strong>
                                    <p>
                                        {{errMsg}}
                                    </p>
                                </div>
                                <div id="outer-block" ng-show="isAccountExist">
                                    <div id="detailBlock" ng-show="!isEdit">
                                        <div ng-show="isInformationSection">
                                            <div class="slds-section-title slds-p-around--xx-small" style="font-size: 15px !important;">
                                                {!$Label.Reference_Information}
                                            </div>
                                            <div class="slds-grid slds-wrap">
                                                <div ng-repeat="field in infoFields" class="slds-col slds-size--1-of-1 slds-medium-size--1-of-2 slds-large-size--1-of-2">
                                                    <div ng-show="field.apiName != ''" ng-hide = "field.apiName == inactiveReason &&  RBI[nameSpace+referenceabilityStatus] != 'Inactive'">
                                                        <div class="slds-form-element">
                                                            <label class="slds-form-element__label" style="margin-right: 0;">{{field.label}}</label>
                                                            <div style="display: inline-flex;" class="tooltip" ng-show="field.inlineHelpText != '' && field.inlineHelpText != null">
                                                                <div class="slds-form-element ">
                                                                    <div class="slds-form-element__icon slds-align-middle" style="margin-left: 16px;">
                                                                    <p  style="color: rgb(176, 173, 171);" aria-describedby="help" title="Help">
                                                                        <svg class="slds-button__icon" aria-hidden="true">
                                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.LightningCSS_2_3, '/assets/icons/utility-sprite/svg/symbols.svg#info')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Help</span>
                                                                    </p>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-fall-into-ground tooltipHelpHide" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-rise-from-ground tooltipHelpShow" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'BOOLEAN'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">
                                                                        <label class="slds-checkbox">
                                                                            <input type="checkbox" ng-model="RBI[nameSpace+field.apiName]" disabled="disabled" />
                                                                            <span class="slds-checkbox--faux"></span>
                                                                        </label>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'DATE' || field.fieldType == 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{field.dateValue}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'REFERENCE'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{field.referenceValue}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType != 'BOOLEAN' && field.fieldType != 'DATE' && field.fieldType != 'DATETIME' && field.fieldType != 'REFERENCE'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static"  ng-show="field.apiName != 'Total_Reference_Use__c'">{{RBI[nameSpace+field.apiName]}}</span>
                                                                    <a ng-click="$parent.showTotalRefs = true;" ng-show="field.apiName == 'Total_Reference_Use__c'">{{RBI[nameSpace+field.apiName]}}</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><hr width="97%" style="margin-top:0;" ng-hide = "field.apiName == inactiveReason &&  RBI[nameSpace+referenceabilityStatus] != 'Inactive'"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-show="isUseLimitSection">
                                            <div class="slds-section-title slds-p-around--xx-small"  style="font-size: 15px !important;">
                                                {!$Label.Reference_Use_Limits}
                                            </div>
                                            <div class="slds-grid slds-wrap">
                                                <div ng-repeat="field in limitFields" class="slds-col slds-size--1-of-1 slds-medium-size--1-of-2 slds-large-size--1-of-2">
                                                    <div ng-show="field.apiName != ''">
                                                        <div class="slds-form-element">
                                                            <label class="slds-form-element__label" style="margin-right: 0;">{{field.label}}</label>
                                                            <div style="display: inline-flex;" class="tooltip" ng-show="field.inlineHelpText != '' && field.inlineHelpText != null">
                                                                <div class="slds-form-element ">
                                                                    <div class="slds-form-element__icon slds-align-middle" style="margin-left: 16px;">
                                                                    <p  style="color: rgb(176, 173, 171);" aria-describedby="help" title="Help">
                                                                        <svg class="slds-button__icon" aria-hidden="true">
                                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.LightningCSS_2_3, '/assets/icons/utility-sprite/svg/symbols.svg#info')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Help</span>
                                                                    </p>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-fall-into-ground tooltipHelpHide" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-rise-from-ground tooltipHelpShow" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'BOOLEAN'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">
                                                                        <label class="slds-checkbox">
                                                                            <input type="checkbox" ng-change="openModal();" ng-model="RBI[nameSpace+field.apiName]" ng-disabled="field.apiName != 'Account_Level_RUL__c'" />
                                                                            <span class="slds-checkbox--faux"></span>
                                                                        </label>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'DATE' || field.fieldType == 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{field.dateValue}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType != 'BOOLEAN' && field.fieldType != 'DATE' && field.fieldType != 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{RBI[nameSpace+field.apiName]}}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><hr width="97%" style="margin-top:0;"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-show="isRewardSection">
                                            <div class="slds-section-title slds-p-around--xx-small" style="font-size: 15px !important;">
                                                {!$Label.Rewards_Status}
                                            </div>
                                            <div class="slds-grid slds-wrap">
                                                <div ng-repeat="field in rewardFields" class="slds-col slds-size--1-of-1 slds-medium-size--1-of-2 slds-large-size--1-of-2">
                                                    <div ng-show="field.apiName != ''">
                                                        <div class="slds-form-element">
                                                            <label class="slds-form-element__label" style="margin-right: 0;">{{field.label}}</label>
                                                            <div style="display: inline-flex;" class="tooltip" ng-show="field.inlineHelpText != '' && field.inlineHelpText != null">
                                                                <div class="slds-form-element ">
                                                                    <div class="slds-form-element__icon slds-align-middle" style="margin-left: 16px;">
                                                                    <p  style="color: rgb(176, 173, 171);" aria-describedby="help" title="Help">
                                                                        <svg class="slds-button__icon" aria-hidden="true">
                                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.LightningCSS_2_3, '/assets/icons/utility-sprite/svg/symbols.svg#info')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Help</span>
                                                                    </p>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-fall-into-ground tooltipHelpHide" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-rise-from-ground tooltipHelpShow" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'BOOLEAN'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">
                                                                        <label class="slds-checkbox">
                                                                            <input type="checkbox" ng-model="RBI[nameSpace+field.apiName]" disabled="disabled" />
                                                                            <span class="slds-checkbox--faux"></span>
                                                                        </label>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType == 'DATE' || field.fieldType == 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{field.dateValue}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-show="field.fieldType != 'BOOLEAN' && field.fieldType != 'DATE' && field.fieldType != 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{RBI[nameSpace+field.apiName]}}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><hr width="97%" style="margin-top:0;"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>                                                                     
                                    <div id="editBlock" ng-show="isEdit">
                                        <div ng-show="isInformationSection">
                                            <div class="slds-section-title slds-p-around--xx-small" style="font-size: 15px !important;">
                                                {!$Label.Reference_Information}
                                            </div> 
                                            <div class="slds-grid slds-wrap">
                                                <div ng-repeat="field in infoFields" class="slds-col slds-size--1-of-1 slds-medium-size--1-of-2 slds-large-size--1-of-2">
                                                    <div ng-show="field.apiName != ''" ng-hide = "field.apiName == inactiveReason &&  RBI[nameSpace+referenceabilityStatus] != 'Inactive'">
                                                        <div class="slds-form-element">
                                                        	<label class="slds-form-element__label" ng-show = "field.apiName != inactiveReason" style="margin-right: 0;">{{field.label}}</label>
                                                            <label class="slds-form-element__label" ng-show = "field.apiName == inactiveReason" style="margin-right: 0;">{!$Label.Inactive_Reason}<span style="font-size: 20px; color: #f00;">*</span></label>
                                                            <div style="display: inline-flex;" class="tooltip" ng-show="field.inlineHelpText != '' && field.inlineHelpText != null">
                                                                <div class="slds-form-element ">
                                                                    <div class="slds-form-element__icon slds-align-middle" style="margin-left: 16px;">
                                                                    <p  style="color: rgb(176, 173, 171);" aria-describedby="help" title="Help">
                                                                        <svg class="slds-button__icon" aria-hidden="true">
                                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.LightningCSS_2_3, '/assets/icons/utility-sprite/svg/symbols.svg#info')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Help</span>
                                                                    </p>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-fall-into-ground tooltipHelpHide" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-rise-from-ground tooltipHelpShow" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'BOOLEAN'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">
                                                                        <label class="slds-checkbox">
                                                                            <input type="checkbox" ng-model="RBI[nameSpace+field.apiName]" />
                                                                            <span class="slds-checkbox--faux"></span>
                                                                        </label>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'DATE' || field.fieldType == 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{field.dateValue}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'CURRENCY'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{RBI[nameSpace+field.apiName]}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'PICKLIST'">
                                                                <div class="slds-form-element__control">
                                                                    <select style="width:97%" class="slds-select" ng-model="RBI[nameSpace+field.apiName]" ng-change="statusChanged(RBI[nameSpace+field.apiName])">
                                                                        <option label="--None--" value=""></option>
                                                                        <option ng-repeat="option in selectOptions" ng-selected="option == RBI[nameSpace+field.apiName]" value="{{option}}">{{option}}</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'TEXTAREA' || field.fieldType == 'DOUBLE'"  ng-hide = "field.apiName == inactiveReason">
                                                                <div class="slds-form-element__control" >
                                                                    <span class="slds-form-element__static">{{RBI[nameSpace+field.apiName]}}</span>
                                                                </div>
                                                            </div> 
                                                            <div ng-if="field.fieldType == 'TEXTAREA'"  ng-hide = "isHidden">
                                                                <div class="slds-form-element__control" ng-show = "field.apiName == inactiveReason">
                                                                    <textarea rows="2" cols="50" class="slds-input" ng-model="RBI[nameSpace+field.apiName]"  style="width:49%" ></textarea>
                                                                </div>
                                                            </div>
                                                            
                                                            <div ng-if="field.fieldType == 'REFERENCE'" >
                                                                <lookup-picklist object-Name="'User'" object-Api-Name="'User'"  selected-Id="RBI[nameSpace+referenceOwner]" selected-Name="field.referenceValue"></lookup-picklist>
                                                            </div>
                                                        </div>
                                                    </div><hr width="97%" style="margin-top:0;" ng-hide = "field.apiName == inactiveReason &&  RBI[nameSpace+referenceabilityStatus] != 'Inactive'"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-show="isUseLimitSection">
                                            <div class="slds-section-title slds-p-around--xx-small" style="font-size: 15px !important;">
                                                {!$Label.Reference_Use_Limits}
                                            </div>
                                            <div class="slds-grid slds-wrap">
                                                <div ng-repeat="field in limitFields" class="slds-col slds-size--1-of-1 slds-medium-size--1-of-2 slds-large-size--1-of-2">
                                                    <div ng-show="field.apiName != ''"> 
                                                        <div class="slds-form-element">
                                                            <label class="slds-form-element__label" style="margin-right: 0;">{{field.label}}</label>
                                                            <div style="display: inline-flex;" class="tooltip" ng-show="field.inlineHelpText != '' && field.inlineHelpText != null">
                                                                <div class="slds-form-element ">
                                                                    <div class="slds-form-element__icon slds-align-middle" style="margin-left: 16px;">
                                                                    <p  style="color: rgb(176, 173, 171);" aria-describedby="help" title="Help">
                                                                        <svg class="slds-button__icon" aria-hidden="true">
                                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.LightningCSS_2_3, '/assets/icons/utility-sprite/svg/symbols.svg#info')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Help</span>
                                                                    </p>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-fall-into-ground tooltipHelpHide" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-rise-from-ground tooltipHelpShow" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'BOOLEAN'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">
                                                                        <label class="slds-checkbox">
                                                                            <input type="checkbox" ng-change="openModal();" ng-model="RBI[nameSpace+field.apiName]" ng-disabled="field.apiName != 'Account_Level_RUL__c'" />
                                                                            <span class="slds-checkbox--faux"></span>
                                                                        </label>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'DATE' || field.fieldType == 'DATETIME'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{field.dateValue}}</span>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'DOUBLE'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static" ng-show="field.apiName == 'RUL_Activities_used__c' || field.apiName == 'RUL_Activities_available__c'">{{RBI[nameSpace+field.apiName]}}</span>
                                                                    <input style="width:97%" type="number" class="slds-input" ng-model="RBI[nameSpace+field.apiName]" ng-show="field.apiName == 'RUL_Period__c' || field.apiName == 'RUL_Activities_will_do__c'" />
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'STRING'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{RBI[nameSpace+field.apiName]}}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><hr width="97%" style="margin-top:0;"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-show="isRewardSection">
                                            <div class="slds-section-title slds-p-around--xx-small" style="font-size: 15px !important;">
                                                {!$Label.Rewards_Status}
                                            </div>
                                            <div class="slds-grid slds-wrap">
                                                <div ng-repeat="field in rewardFields" class="slds-col slds-size--1-of-1 slds-medium-size--1-of-2 slds-large-size--1-of-2">
                                                    <div ng-show="field.apiName != ''">
                                                        <div class="slds-form-element">
                                                            <label class="slds-form-element__label" style="margin-right: 0;">{{field.label}}</label>
                                                            <div style="display: inline-flex;" class="tooltip" ng-show="field.inlineHelpText != '' && field.inlineHelpText != null">
                                                                <div class="slds-form-element ">
                                                                    <div class="slds-form-element__icon slds-align-middle" style="margin-left: 16px;">
                                                                    <p  style="color: rgb(176, 173, 171);" aria-describedby="help" title="Help">
                                                                        <svg class="slds-button__icon" aria-hidden="true">
                                                                            <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.LightningCSS_2_3, '/assets/icons/utility-sprite/svg/symbols.svg#info')}" />
                                                                        </svg>
                                                                        <span class="slds-assistive-text">Help</span>
                                                                    </p>
                                                                    </div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-fall-into-ground tooltipHelpHide" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                                <div class="slds-popover slds-popover_tooltip slds-nubbin_bottom-left slds-rise-from-ground tooltipHelpShow" role="tooltip" id="help">
                                                                    <div class="slds-popover__body" style="padding: 0.5rem;">{{field.inlineHelpText}}</div>
                                                                </div>
                                                            </div>
                                                            <div ng-if="field.fieldType == 'DOUBLE'">
                                                                <div class="slds-form-element__control">
                                                                    <span class="slds-form-element__static">{{RBI[nameSpace+field.apiName]}}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div><hr width="97%" style="margin-top:0;"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div> 
                                    <div ng-show="showConfirmation">
                                        <div class="slds-modal slds-fade-in-open" aria-hidden="false" role="dialog">
                                            <div class="slds-modal__container">
                                                <div class="slds-modal__header">
                                                    <a class="slds-button slds-button--icon-inverse slds-modal__close" ng-click="showConfirmation = false;">
                                                        <img id="close-Image" src="{!URLFOR($Resource.LightningCSS, '/assets/icons/action/close_120.png')}" alt="close" height="20" width="20"/>
                                                        <span class="slds-assistive-text">Close</span>
                                                    </a>
                                                    <h2 class="slds-text-heading--medium" style="font-family: 'Salesforce Sans',Arial,sans-serif!important;">{!$Label.Send_notification}</h2>
                                                </div>
                                                <div class="slds-modal__content slds-p-around--medium">
                                                    <div>
                                                        {{confirmMsg}}
                                                    </div>
                                                </div>
                                                <div class="slds-modal__footer">
                                                    <a class="slds-button slds-button--brand" ng-click="saveRBI(true)">{!$Label.Yes}</a>
                                                    <a class="slds-button slds-button--neutral" ng-click="showConfirmation = false;">{!$Label.No}</a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="slds-backdrop slds-backdrop--open"></div>
                                    </div>                                  
                                </div> 
                        		</div>
                        </form>
                    </div>
                </div>
            </div>
        </body>
    </html>
</apex:page> 