<!--
 * ReferenceEdge
 * 
 * Point of Reference, Inc. - Copyright 2014 All rights reserved.
 *
 * @company : Point of Reference, Inc.
 * @website : www.point-of-reference.com
 *
 * Disclaimer: THIS SOFTWARE IS PROVIDED "AS-IS" BY POINT OF REFERENCE ("POR"), 
 * WITH NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, 
 * EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
 * POR SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, 
 * MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES. POR IS NOT LIABLE FOR, 
 * AND MAKES NO REPRESENTATIONS OR WARRANTIES REGARDING, THE ACTIONS OR OMISSIONS OF 
 * ANY THIRD PARTIES (OR THE PRODUCTS OR SERVICES OFFERED BY ANY THIRD PARTIES) INCLUDING, 
 * WITHOUT LIMIATION, SALESFORCE.COM. COPY, USE OR DISTRIBUTION PROHIBITED WITHOUT EXPRESS 
 * WRITTEN CONSENT FROM COMPANY.
 -->
<apex:page Controller="RedeemRewardController" id="pageId" tabstyle="Reward__c" sidebar="false" applyHtmlTag="true" applyBodyTag="false" docType="html-5.0">
    <apex:outputPanel rendered="{!!isSLDS}">
        <!-- Messages -->
        <apex:pageMessages id="pgmsgId"/>
        <!-- Add POR_ModalLoader Component-->
        <c:POR_ModalLoader id="PORLoader"/>
        <apex:pageMessage summary="{!$Label.Insufficient_Privileges}" strength="3" severity="Info" rendered="{!IF(isFullLicenseAccessible,NOT(IsPageAccessible),isFullLicenseAccessible)}" />
        <apex:pageMessage summary="{!$Label.User_License}" strength="3" severity="Info" rendered="{!NOT(isFullLicenseAccessible)}" />
        <!-- Java Script -->
        <apex:outputPanel id="jsPanel">
            <script>
                var isContactReferenceable = {!contactReferenceability};
				var isContactSelected = {!isContactSelected};
				var accountMSG = '{!JSENCODE(status)}'.replace('@@@1', '{!$Label.Account}');
				var contactMSG = '{!JSENCODE(status)}'.replace('@@@1', '{!$Label.Contact}');
				var userId = '{!JSENCODE(userId)}';
				
				function showPopup() {
				
				    if (isContactSelected && !isContactReferenceable && userId == '') {
				        var where_to = confirm(contactMSG);
				
				        if (where_to) {
				            return true;
				        } else {
				            return false;
				        }
				    } else if ({!!accountReferenceability} && userId == '') {
				        var where_to = confirm(accountMSG);
				        
				        if (where_to) {
				            return true;
				        } else {
				            return false;
				        }
				    }
				}
				
				/* Function used to redirect to previous page.- re #1112 */
		    	function returnToPrevious() { 
		    		 
		    		if (userId == null || userId == '') {
		    			window.location = '/'+ '{!returnUrl}';
		    		} else {
		    			window.location = '{!returnUrl}';
		    		} 
		    	}
            </script>
        </apex:outputPanel>
        <style>
            .pbSubheader
            {
            	background-image : none !important;
            }
        </style>
        <!-- Form -->
        <apex:form id="formId" rendered="{!AND(IsPageAccessible,isFullLicenseAccessible)}">
            <apex:actionFunction name="findReferenceStatus" oncomplete="PORHideLoading();"  immediate="true" action="{!getReferenceStatus}" rerender="jsPanel,availId">
                <apex:param assignTo="{!selectedContact}" value="" name="paramName"/>
            </apex:actionFunction>
            <!-- Section Header-->
            <apex:sectionHeader title="{!$Label.Redeem_Reward}"/>
            <apex:pageMessage summary="There are more than 1000 records to display in the Account/Contact picklist, first 1000 records are displayed." strength="3" severity="Info" rendered="{!isLimitExceeded}" />
            <!-- Page Block -->
            <apex:pageBlock id="blockId" title="{!$Label.Redeem_Reward}"  mode="Edit">
                <!-- Page Block Buttons-->
                <apex:pageBlockButtons id="pbbId">
                    <apex:commandButton value="{!$Label.Save}" action="{!Save}"  onclick="return showPopup();"/>  
					<button type="button" onclick="returnToPrevious(); return false;" style="height: 21px;">{!$Label.Cancel}</button>
                </apex:pageBlockButtons>
                <!-- Page Block Section-->
                <apex:pageBlockSection id="sectionId" title="{!$Label.Information}" columns="1">
                    <apex:outputField value="{!reward.Account__c}" rendered="{!AND(userId = null,OR(!isSharedContact,reward.Contact__c == null,isAccountRedeem))}"/>
                    <!-- User (When From Sales User Profile)-->
                    <apex:outputField value="{!reward.User__c}" rendered="{!userId != null}"/>
                    <!-- Contact (When From Account)-->
                    <apex:pageBlockSectionItem id="contactItemId" rendered="{!userId = null && OR(contacts.size > 2,isAccountRedeem)}">
                        <apex:outputLabel value="{!$Label.Contact}"/>
                        <apex:selectList value="{!reward.Contact__c}" size="1" onchange="PORShowLoading();findReferenceStatus(this.value);" id="selectedContact">
                            <apex:selectOptions value="{!contacts}" />
                        </apex:selectList>
                    </apex:pageBlockSectionItem>
                    <!-- Contact (When From Contact)-->
                    <apex:outputField value="{!reward.Contact__c}" rendered="{!userId = null && AND(contacts.size <= 2,!isAccountRedeem)}"/>
                    <apex:inputField value="{!reward.Amount__c}" required="true">
                        <apex:outputLabel value="{!$Label.Cannot_Exceed}"/>
                    </apex:inputField>
                    <apex:outputText id="availId" label="{!$Label.Available_Balance}" value="{!availableBalance}"/>
                    <apex:outputField value="{!reward.RewardDate__c}"/>
                    <apex:inputField value="{!reward.Comments__c}"/>
                </apex:pageBlockSection>
            </apex:pageBlock>
        </apex:form>
    </apex:outputPanel>
    <apex:include pageName="RedeemRewardSLDS" rendered="{!isSLDS}"/>
</apex:page>