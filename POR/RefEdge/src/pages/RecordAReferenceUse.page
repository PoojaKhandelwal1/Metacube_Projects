<!--
 * ReferenceEdge
 * 
 * Point of Reference, Inc. - Copyright 2014 All rights reserved.
 *
 * @company : Point of Reference, Inc.
 * @website : www.point-of-reference.com
 *
 * Disclaimer: THIS SOFTWARE IS PROVIDED "AS-IS" BY POINT OF REFERENCE ("POR"), 
 * WITH NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE SOFTWARE, 
 * EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED WARRANTIES 
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, OR NON-INFRINGEMENT. 
 * POR SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE AS A RESULT OF USING, 
 * MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS DERIVATIVES. POR IS NOT LIABLE FOR, 
 * AND MAKES NO REPRESENTATIONS OR WARRANTIES REGARDING, THE ACTIONS OR OMISSIONS OF 
 * ANY THIRD PARTIES (OR THE PRODUCTS OR SERVICES OFFERED BY ANY THIRD PARTIES) INCLUDING, 
 * WITHOUT LIMIATION, SALESFORCE.COM. COPY, USE OR DISTRIBUTION PROHIBITED WITHOUT EXPRESS 
 * WRITTEN CONSENT FROM COMPANY.
 -->
<apex:page controller="RecordAReferenceUseExtension" id="pageId" sidebar="false"
         applyHtmlTag="true" applyBodyTag="false" docType="html-5.0" lightningStylesheets="true">
	<apex:outputPanel rendered="{!!isSLDS}">
	    <apex:pageMessages id="pgmsgId"/>
	    <c:POR_ModalLoader id="PORLoader"/>
	    <apex:pageMessage summary="{!$Label.User_License}" strength="3" severity="Info" rendered="{!NOT(isFullLicenseAccessible)}" />
	    <style>
	        .pbSubheader
	        {
	            background-image : none !important;
	        }
	    </style>
	    
	    <apex:outputPanel id="jsPanel">
	        <script>
	            var isContactReferenceable = {!contactReferenceability};
	            var isContactSelected = {!isContactSelected}; 
	            var accountMSG = '{!JSENCODE(status)}'.replace('@@@1', '{!$Label.Account}');
				var contactMSG = '{!JSENCODE(status)}'.replace('@@@1', '{!$Label.Contact}');
				
				function showPopup() {
				    var state;
				    
				    if (isContactSelected && !isContactReferenceable) {
				        state = confirm(contactMSG);
				    } else if ({!!accountReferenceability}) {
				        state = confirm(accountMSG);
				    }
				
				    if (typeof state != 'undefined' && !state) {
				        PORHideLoading();
				    } else {
				        saveContent();
				    }
				    return false;
				}
				/*
				 *  re #119 This function will show Disolving Alert for sales reward
				 */
				function showDisolvingAlert() {
				
				    if ('{!isError}' != true && '{!isError}' != 'true') {
				        var points = jQuery("input[id*='rewardPoints']").val();
				        var message = jQuery("input[id*='actionMessage']").val();
				
				        if (typeof points != 'undefined' && points != '' && points != '0') {
				            notificationForRefUse(points, message);
				            //window.setTimeout(redirect(),10000);
				        } else {
				            PORHideLoading();
				            redirect();
				        }
				    } else {
				        PORHideLoading();
				    }
				}
				
				function redirectToBack() {
				    redirect();
				}
				
				/* Function used to redirect to previous page.- re REF-1522
 				 */
		    	function returnToPrevious() {  
		    		window.open('{!returnUrl}', "_self"); 
		    	}
	        </script>
	    </apex:outputPanel>
	    
	    <!-- Form -->
	    <apex:form id="formId"  rendered="{!isFullLicenseAccessible}">
	        <c:RewardNotification />
	        <apex:sectionHeader title="{!$Label.Record_A_Reference_Use}" subtitle="{!$Label.Record_a_Reference}"/>
	        <apex:actionFunction name="saveContent" action="{!saveContent}" reRender="pgmsgId,points,jsPanel" oncomplete="showDisolvingAlert();"/>
	        <apex:actionFunction name="redirect" action="{!cancel}" reRender="pgmsgId"/>
	        <apex:actionFunction name="jsFindReferenceStatus" oncomplete="PORHideLoading();"  immediate="true" action="{!getReferenceStatus}" rerender="jsPanel,howDidPbsId">
	            <apex:param assignTo="{!selectedContact}" value="" name="paramName"/>
	        </apex:actionFunction>
	        <apex:actionFunction name="jsFindAccountReferenceStatus" oncomplete="PORHideLoading();"  immediate="true" action="{!getAccountReferenceStatus}" rerender="jsPanel">
	            <apex:param assignTo="{!selectedAccount}" value="" name="paramName"/>
	        </apex:actionFunction>
	        <apex:outputPanel id="points">
	        	<apex:inputHidden value="{!rewardPoints}" id="rewardPoints"/>
	        	<apex:inputHidden value="{!actionMessage}" id="actionMessage"/>
	        </apex:outputPanel>
	        <apex:actionFunction reRender="pgmsgId, unsuccessfulPanel"  immediate="true" name="displayTextArea" oncomplete="PORHideLoading();">
	            <apex:param assignTo="{!feedbackSelected}" value="" name="paramName"/>
	        </apex:actionFunction>
	        <apex:pageMessage summary="There are more than 1000 records to display in the Account/Contact picklist, first 1000 records are displayed." strength="3" severity="Info" rendered="{!isLimitExceeded}" />
	        <apex:pageBlock id="blockId" title="{!$Label.Record_A_Reference_Use}" mode="edit">
	            <apex:pageBlockButtons >
	                <apex:commandButton value="{!$Label.Save}" onclick="PORShowLoading();return showPopup();"/> 
	                <apex:commandButton value="{!$Label.Cancel}" onclick="returnToPrevious(); return false;"/>
	                <apex:commandButton value="{!$Label.Save_and_New}" action="{!saveAndNew}" onclick="PORShowLoading();" reRender="pgmsgId,points,jsPanel" oncomplete="showDisolvingAlert();"/>
	            </apex:pageBlockButtons>
	            
	            <apex:pageBlockSection id="SectionId" columns="1">
	                <apex:pageBlockSectionItem id="refType">
	                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account__c.fields.Reference_Type_Needed__c.Label}" />
	                    <apex:outputPanel styleClass="requiredInput" layout="block" >
	                        <div class="requiredBlock"></div>
	                        <apex:selectList size="1" value="{!refReqAccountObject.Reference_Type_Needed__c}" id="selectRefType" style="width:250px" required="true">
	                            <apex:selectOptions value="{!referenceabilityTypes}"/>
	                        </apex:selectList>
	                    </apex:outputPanel>
	                </apex:pageBlockSectionItem>
	                
	                <apex:inputField id="Opportunity1" value="{!refReqObject.Opportunity__c}" rendered="{!OR(fromAccount, fromContact)}"/> 
	                <apex:outputField id="Opportunity2" value="{!refReqObject.Opportunity__c}" rendered="{!fromOpportunity}"/>
	                
	                <apex:pageBlockSectionItem id="Contact" rendered="{!AND(associatedContacts.size > 0, showContactPicklist)}">
	                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account_Contact__c.fields.Contact__c.Label}" />
	                    <apex:selectList size="1" value="{!refReqAccContactObject.Contact__c}" id="ContactId" onchange="PORShowLoading();jsFindReferenceStatus(this.value);">
	                        <apex:selectOptions value="{!associatedContacts}"/>                 
	                    </apex:selectList>
	                </apex:pageBlockSectionItem>
	                <apex:outputField id="Contact1" value="{!refReqAccContactObject.Contact__c}" rendered="{!associatedContacts.size == 0}"/>
	                <apex:pageBlockSectionItem id="Account1" rendered="{!accounts.size > 1}">
	                    <apex:outputLabel value="{!$ObjectType.Reference_Request_Account__c.fields.Account__c.Label}" />
	                    <apex:selectList size="1" value="{!refReqAccountObject.Account__c}" id="AccountId" onchange="PORShowLoading();jsFindAccountReferenceStatus(this.value);">
	                        <apex:selectOptions value="{!accounts}"/>                 
	                    </apex:selectList>
	                </apex:pageBlockSectionItem>
	                <apex:outputField id="Account" value="{!refReqAccountObject.Account__c}" rendered="{!accounts.size <= 1}"/>
	                <apex:inputField id="Comment" value="{!refReqAccountObject.Request_Notes__c}" label="{!$Label.Notes}"/>
	                <apex:inputField id="ActivityDate" value="{!refReqAccountObject.Activity_Date__c}" required="true"/>
	            </apex:pageBlockSection>
	            <apex:outputPanel id="howDidPbsId">
	                <apex:pageBlockSection title="{!$Label.How_did_it_go}"  columns="1" rendered="{!selectedContact != null}">
	                    <apex:pageBlockSectionItem >
	                        <apex:outputLabel value="{!$ObjectType.Reference_Request_Account_Contact__c.fields.Feedback_Status__c.Label}" />
	                        <apex:outputPanel styleClass="requiredInput" layout="block" >
	                            <div class="requiredBlock"></div>
	                            <apex:selectList size="1" value="{!refReqAccContactObject.Feedback_Status__c}" style="width:250px" required="true" onChange="PORShowLoading();displayTextArea(this.value);return false;">
	                                <apex:selectOptions value="{!feedbackOption}"/>
	                            </apex:selectList>
	                        </apex:outputPanel>
	                    </apex:pageBlockSectionItem>
	                    
	                    <apex:outputPanel id="unsuccessfulPanel" >
	                        <apex:outputPanel style="padding-left:18%;" rendered="{!feedbackSelected == useCompleted}">
	                            <h3>{!$Label.sorry_what_happened}</h3><br/>
	                            <div style="padding-left:18%;">
	                            <apex:pageBlockSectionItem id="whatHappenPbsmsgId" dataStyleClass="padding-left:18%;">
	                                <apex:outputPanel styleClass="requiredInput" layout="block" >
	                                <div class="requiredBlock"></div>
	                                    <apex:inputTextarea cols="50" rows="5" value="{!refReqAccContactObject.Feedback_Response__c}" />    
	                                </apex:outputPanel>
	                            </apex:pageBlockSectionItem>
	                            </div>
	                        </apex:outputPanel>
	                        
	                        <apex:outputPanel style="padding-left:18%;" rendered="{!feedbackSelected == useCompleted_Success}">
	                            <h3>That's great! Any highlights you want to share?</h3><br/>
	                            <div style="padding-left:18%;">
	                            <apex:pageBlockSectionItem id="successPbsmsgId" dataStyleClass="padding-left:18%;">
	                                <apex:outputPanel layout="block" >
	                                    <apex:inputTextarea cols="50" rows="5" value="{!refReqAccContactObject.Feedback_Response__c}" />    
	                                </apex:outputPanel>
	                            </apex:pageBlockSectionItem>
	                            </div>
	                        </apex:outputPanel>
	                    </apex:outputPanel>
	                </apex:pageBlockSection>
	            </apex:outputPanel>
	        </apex:pageBlock>
	    </apex:form>
    </apex:outputPanel>
    <apex:include pageName="RecordAReferenceUseSLDS" rendered="{!isSLDS}"/>
</apex:page>